name: CI/CD - Tests et Build

on:
  push:
    branches: [ main, develop, JoaDouillard ]
  pull_request:
    branches: [ main, develop ]

jobs:
  tests:
    name: Tests unitaires Backend
    runs-on: ubuntu-latest

    steps:
    - name: Checkout du code
      uses: actions/checkout@v3

    - name: Configuration Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Installation des dependances
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: Linting avec flake8
      working-directory: ./backend
      run: |
        # Stop le build si il y a des erreurs de syntaxe ou des noms non definis
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Warnings (non bloquant)
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      continue-on-error: true

    - name: Execution des tests avec pytest
      working-directory: ./backend
      run: |
        pytest -v --cov=app --cov-report=term-missing --cov-report=xml

    - name: Upload du rapport de coverage
      uses: codecov/codecov-action@v3
      with:
        files: ./backend/coverage.xml
        flags: unittests
        name: codecov-umbrella
      continue-on-error: true

  docker-build:
    name: Build des images Docker
    runs-on: ubuntu-latest
    needs: tests

    steps:
    - name: Checkout du code
      uses: actions/checkout@v3

    - name: Configuration Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build de l'image Backend
      uses: docker/build-push-action@v4
      with:
        context: ./backend
        file: ./backend/Dockerfile
        push: false
        tags: meteo-backend:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build de l'image Frontend
      uses: docker/build-push-action@v4
      with:
        context: ./frontend
        file: ./frontend/Dockerfile
        push: false
        tags: meteo-frontend:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

  integration-tests:
    name: Tests d'integration avec Docker Compose
    runs-on: ubuntu-latest
    needs: docker-build

    steps:
    - name: Checkout du code
      uses: actions/checkout@v3

    - name: Creation du fichier secret pour les tests
      run: |
        mkdir -p secrets
        echo "test_api_key_for_ci" > secrets/weather_api_key.txt

    - name: Demarrage des services avec Docker Compose
      run: |
        docker compose up -d --build

    - name: Attente du demarrage des services
      run: |
        sleep 15

    - name: Test du endpoint health
      run: |
        curl -f http://localhost:5000/health || exit 1

    - name: Verification des logs
      if: always()
      run: |
        docker compose logs

    - name: Arret des services
      if: always()
      run: |
        docker compose down -v
